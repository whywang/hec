<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>木门订单详情</title>
    <link href="../../../Styles/Common/toastr.css" rel="stylesheet" type="text/css" />
    <link href="../../../Styles/Calendar/fullcalendar.css" rel="stylesheet" type="text/css" />
</head>
<body style='overflow:auto'>
    <div id='loading'>
        <img src="../../../runtime/loading.gif" alt="Loading..." />加载中......</div>
    <script src="../../../Scripts/Common/json2.js" type="text/javascript"></script>
    <script src="../../../runtime/jsLinb/js/linb-debug.js" type="text/javascript"></script>
    <script src="../../../runtime/jsLinb/js/adv-debug.js" type="text/javascript"></script>
    <script src="../../../Scripts/Common/jquery-1.4.1.js" type="text/javascript"></script>
    <script src="../../../Scripts/Common/Common.js" type="text/javascript"></script>
    <script src="../../../Scripts/Valid/ValReturn.js" type="text/javascript"></script>
    <script src="../../../Scripts/Valid/ValInput.js" type="text/javascript"></script>
    <script src="../../../Scripts/Api/SysMenuCode.js" type="text/javascript"></script>
    <script src="../../../Scripts/Api/ITabs.js" type="text/javascript"></script>
    <script src="../../../Scripts/Common/INotify.js" type="text/javascript"></script>
    <script src="../../../Scripts/Common/toastr.js" type="text/javascript"></script>
    <script src="../../../Scripts/Calendar/moment.js" type="text/javascript"></script>
    <script src="../../../Scripts/Api/Idepment.js" type="text/javascript"></script>
    <script src="../../../Scripts/Api/IButton.js" type="text/javascript"></script>
    <script src="../../../Scripts/Api/IEventBtnDo.js" type="text/javascript"></script>
    <script src="../../../Scripts/Calendar/fullcalendar/fullcalendar.js" type="text/javascript"></script>
    <script src="../../../Scripts/Calendar/fullcalendar/locale-all.js" type="text/javascript"></script>
    <script type="text/javascript">

        Class('App', 'linb.Com', {

            Instance: {

                initialize: function () {

                    this.autoDestroy = true;

                    this.properties = {};
                },

                iniComponents: function () {
                    // [[code created by jsLinb UI Builder
                    var host = this, children = [], append = function (child) { children.push(child.get(0)) };

                    append(
                (new linb.DataBinder)
                .setHost(host, "binder")
                .setName("binder")
            );

                    append(
                (new linb.UI.Panel)
                .setHost(host, "pane")
                .setDock("top")
                .setHeight(30)
                .setZIndex(1)
                .setCaption("工作日程")
            );

                    append(
                (new linb.UI.ToolBar)
                .setHost(host, "toolbar")
                .setItems([{ "id": "grp1", "sub": [{ "id": "a1", "caption": "返回"}], "caption": "grp1"}])
                .onClick("_toolbar_onclick")
            );

                    append(
                (new linb.UI.Dialog)
                .setHost(host, "rdlg")
                .setLeft(140)
                .setTop(140)
                .setWidth(570)
                .setHeight(400)
                .setCaption("日程设置")
                .setMinBtn(false)
                .setMaxBtn(false)
                .setDisplay("none")
            );

                    host.rdlg.append(
                (new linb.UI.Pane)
                .setHost(host, "prt")
                .setDock("top")
                .setHeight(220)
            );

                    host.prt.append(
                (new linb.UI.ToolBar)
                .setHost(host, "stoolbar")
                .setItems([{ "id": "grp1", "sub": [{ "id": "a1", "caption": "确定" }, { "id": "a2", "type": "split", "split": true }, { "id": "a3", "caption": "删除" }, { "id": "a2", "type": "split", "split": true }, { "id": "a4", "caption": "取消"}], "caption": "grp1"}])
                .onClick("_stoolbar_onclick")
            );

                    host.prt.append(
                (new linb.UI.Pane)
                .setHost(host, "rbj")
                .setLeft(20)
                .setTop(70)
                .setWidth(100)
                .setHeight(100)
                .setCustomStyle({ "KEY": "background:#ffffff;border:5px solid #f2f2f2;border-radius:5px" })
            );

                    host.rbj.append(
                (new linb.UI.SLabel)
                .setHost(host, "sl2")
                .setLeft(20)
                .setTop(40)
                .setCaption("<span style='font-size:16px;font-weight:bolder;color:#999999'>新增日程</span>")
            );

                    host.prt.append(
                (new linb.UI.ComboInput)
                .setHost(host, "fcode")
                .setLeft(170)
                .setTop(50)
                .setWidth(255)
                .setHeight(48)
                .setLabelSize(20)
                .setLabelPos("top")
                .setLabelHAlign("left")
                .setType("listbox")
                .setDataBinder("binder")
                .setReadonly(true)
                .setDataField("fcode")
                .setLabelCaption("<span style='font-size:14px;color:#999999'>生产工厂</span>")
            );

                    host.prt.append(
                (new linb.UI.ComboInput)
                .setHost(host, "wtype")
                .setLeft(170)
                .setTop(150)
                .setWidth(255)
                .setHeight(48)
                .setLabelSize(20)
                .setLabelPos("top")
                .setLabelHAlign("left")
                .setType("listbox")
                .setItems([{ "id": "上午生产", "caption": "上午生产" }, { "id": "下午生产", "caption": "下午生产" }, { "id": "晚上生产", "caption": "晚上生产"}])
                .setDataBinder("binder")
                .setDataField("wtype")
                .setLabelCaption("<span style='font-size:14px;color:#999999'>时段</span>")
            );

                    host.prt.append(
                (new linb.UI.Input)
                .setHost(host, "wdate")
                .setLeft(170)
                .setTop(100)
                .setWidth(270)
                .setHeight(48)
                .setLabelSize(20)
                .setLabelPos("top")
                .setDataBinder("binder")
                .setDataField("wdate")
                .setLabelCaption("<span style='font-size:14px;color:#999999'>日期</span>")
                .setLabelHAlign("left")
            );

                    host.rdlg.append(
                (new linb.UI.TreeGrid)
                .setHost(host, "rtreegrid")
                .setSelMode("multi")
                .setAltRowsBg(true)
                .setRowNumbered(true)
                .setHeaderHeight(25)
                .setRowHeight(25)
                .setHeader([{ "id": "col1", "width": 160, "type": "input", "caption": "工作内容" }, { "id": "col2", "width": 160, "type": "input", "caption": "开始" }, { "id": "col3", "width": 160, "type": "input", "caption": "结束"}])
                .setNoCtrlKey(false)
            );

                    return children;
                    // ]]code created by jsLinb UI Builder
                },

                iniExComs: function (com, threadid) {
                },

                customAppend: function (parent, subId, left, top) {

                    return false;
                },
                events: { "onReady": "_onready" },
                _onready: function () {
                    ns = this, sid = "",emcode="", sebobj = SysEmCode;
                    emcode=sebobj.IQueryCode("0152")
                    var Request = new Object();
                    Request = GetRequest();
                    if (Request["Sid"] != null) {
                        sid = Request["Sid"].toString();
                    }
                    IdepOnlyItemsByAtrr("gc", ns.fcode)
                    QueryFactory()
                    SinglePageBar(emcode, "", ns.toolbar);
                },
                _toolbar_onclick: function (profile, item, group, e, src) {
                    var ns = this, uictrl = profile.boxing();
                    bcode = item.bcode;
                    BtnDo(sid, emcode, item)
                },
                _stoolbar_onclick: function (profile, item, group, e, src) {
                    var ns = this, uictrl = profile.boxing();
                    if (item.id == "a1") {
                        var vid = ns.wtype.getUIValue();
                        if (vid == null || vid == "") {
                            linb.warn("请选择工作类型")
                            return;
                        }
                        SaveSchedule();
                    }
                    if (item.id == "a3") {
                        var vid = ns.rtreegrid.getUIValue();
                        if (vid == null || vid == "") {
                            linb.warn("请选择记录")
                            return;
                        }
                        linb.confirms("确定删除？", "DelSchedule('" + vid + "')")
                    }
                    if (item.id == "a4") {
                        ns.rdlg.setDisplay("none");
                    }
                }

            }
        });
        linb.UI.setTheme(themes);
        linb.Com.load('App', function () { linb('loading').remove(); }, 'en');
        $(document).ready(function () {
            //页面加载完初始化日历 
            $('#calendar').fullCalendar({
                headerToolbar: {
                    left: 'prev,next,today',
                    center: 'title',
                    right: 'dayGridMonth'
                },
                height: 600,
                locale: 'zh-cn',
                fixedWeekCount: false,
                allDayText: "全天",
                weekNumbers: false,
                editable: false,
                buttonText: {
                    today: '今天',
                    dayGridMonth: '月'
                },
                eventClick: function (event) {
                },
                events: function (start, end, timezone, callback) {
                    var mnum = "";
                    var m = $('#calendar').fullCalendar('getView').title;
                    if (m) {
                        mnum = YueToMonth(m);
                    }
                    var arrs = InitSchedule(mnum);
                    var event = new Array();
                    for (var i = 0; i < arrs.length; i++) {
                        var oj = arrs[i]
                        event.push(
                       {
                           id: oj.id,
                           title: oj.title,
                           start: oj.start,
                           end: oj.end,
                           color: oj.color
                       }
                       )
                    }
                    callback(event)
                },
                dayClick: function (day) {
                    var gm = day.format("M")
                    var dt = new Date()
                    var cm = dt.Format("M")
                    if (gm == cm) {
                        ns.rdlg.setDisplay("block");
                        ns.wdate.setUIValue(day.format())
                        QueryDay(day.format())
                    }
                }
            })

        });
        function InitSchedule(m) {
            var arr = new Array();
            var url = '../../../UIServer/ProductionBusiness/WorkSchedule/WorkScheduleDetail.aspx/InitWorkSchedule';
            var o = {"mnum":m}
            var b = AjaxExb(url,o);
            var r = BackVad(b, "", false)
            if (r) {
                for (i = 1; i < r.length; i++) {
                    var cel = r[i].toString().split(',')
                    arr.push({ "id": cel[0], "title": cel[1], "start": cel[2], "end": cel[3] ,"color": cel[4] , "className": cel[5],"allDay": true})
                }
            }
            return arr;
        }
        function InitNextSchedule() {
            var arr = new Array();
            var url = '../../../UIServer/ProductionBusiness/WorkSchedule/WorkScheduleDetail.aspx/InitNextWorkSchedule';
            var b = AjaxEb(url);
            var r = BackVad(b, "", false)
            if (r) {
                for (i = 1; i < r.length; i++) {
                    var cel = r[i].toString().split(',')
                    arr.push({ "id": cel[0], "title": cel[1], "start": cel[2], "end": cel[3], "color": cel[4], "className": cel[5], "allDay": true })
                }
            }
            return arr;
        }
        function SaveSchedule() {
            var dc = ns.fcode.getUIValue()
            var dv = ns.wdate.getUIValue()
            var wv = ns.wtype.getUIValue()
            var url = '../../../UIServer/ProductionBusiness/WorkSchedule/WorkScheduleDetail.aspx/SaveWorkSchedule';
            var o = { "dcode": dc, "wdate": dv ,"wtype":wv}
            var b = AjaxExb(url,o);
            var r = BackVad(b, "", false)
            ns.rdlg.setDisplay("none");
            $('#calendar').fullCalendar('refetchEvents');
            QueryDay(dv) 

        }
        function DelSchedule(id) {
            var dv = ns.wdate.getUIValue()
            var url = '../../../UIServer/ProductionBusiness/WorkSchedule/WorkScheduleDetail.aspx/DelWorkSchedule';
            var o = { "id": id }
            var b = AjaxExb(url, o);
            BackVad(b, "", false)
            $('#calendar').fullCalendar('refetchEvents');
            QueryDay(dv);
        }
        function QueryDay(dv) {
            var dc=ns.fcode.getUIValue()
            var url = '../../../UIServer/ProductionBusiness/WorkSchedule/WorkScheduleDetail.aspx/QueryDayWorkSchedule';
            var o = {"dcode":dc,"wdate":dv}
            var b = AjaxExb(url,o);
            var r = BackVad(b, "", false)
            if (r) {
                var arr = new Array();
                for (i = 1; i < r.length; i++) {
                    var cel = r[i].toString().split(',')
                    arr.push({ "id": cel[0], "cells": [{ "value": cel[1] }, { "value": cel[2] }, { "value": cel[3] }, { "value": cel[4] }, { "value": cel[5] }, { "value": cel[6] }, { "value": cel[7] }, { "value": cel[8] }, { "value": cel[9] }, { "value": cel[10] }, { "value": cel[11] }, { "value": cel[12] }, { "value": cel[13] }, { "value": cel[14] }, { "value": cel[15]}] })
                }
            }
            ns.rtreegrid.setRows(arr);
        }
        function QueryFactory() {
            var url = '../../../UIServer/BaseSet/DepManage/Depment.aspx/QueryLoginUser';
            var b = AjaxEb(url);
            var r = BackVad(b, "", false)
            if (r) {

                if (r.dattr == "gc") {
                    ns.fcode.setValue(r.dcode)
                }
            }
        }
        function SetNextMonth() {
            InitNextSchedule();
            $('#calendar').fullCalendar('refetchEvents');
        }
        function YueToMonth(m) {
            if (m.indexOf("一月") > -1) {
                mnum = 2
            }
            if (m.indexOf("二月") > -1) {
                mnum = 3
            }
            if (m.indexOf("三月") > -1) {
                mnum = 4
            }
            if (m.indexOf("四月") > -1) {
                mnum = 5
            }
            if (m.indexOf("五月") > -1) {
                mnum = 6
            }
            if (m.indexOf("六月") > -1) {
                mnum = 7
            }
            if (m.indexOf("七月") > -1) {
                mnum = 8
            }
            if (m.indexOf("八月") > -1) {
                mnum = 9
            }
            if (m.indexOf("九月") > -1) {
                mnum = 10
            }
            if (m.indexOf("十月") > -1) {
                mnum = 11
            }
            if (m.indexOf("十一月") > -1) {
                mnum = 12
            }
            if (m.indexOf("十二月")>-1) {
                mnum = 1
            }
            return mnum;
        }
    </script>
    <center>
        <div style='margin-top: 62px; width: 100%; background: #f2f2f2; height: 800px'>
            <div style=' margin-top:60px; width: 98%; background: #ffffff; height: 800px'>
                <div id="calendar">
                </div>
            </div>
        </div>
    </center>
</body>
</html>
